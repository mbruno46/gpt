#!/bin/bash
# Configure
root="$( cd "$( dirname "${BASH_SOURCE[0]}" )/../.." >/dev/null 2>&1 && pwd )"
GRID=${root}/dependencies/Grid/build
if [ ! -d ${GRID} ];
then
    GRID=${root}/../Grid/build
fi
if [ ! -d ${GRID} ];
then
    echo "Could not detect Grid location"
    exit 2
fi
NPARALLEL=32

# Start
N=0

mkdir -p build logs

echo "================================================================================"
echo "  Compiling CGPT against Grid in ${GRID}"
echo "================================================================================"

NUMPY_INCLUDE=$(python3 -c "import numpy; print(numpy.get_include())")
CXX=$(grep "GRID_CXX " ${GRID}/Makefile | sed "s/^[^=]*=//")
CXXFLAGS="$(grep "GRID_CXXFLAGS " ${GRID}/Makefile | sed "s/^[^=]*=//") $(grep "AM_CFLAGS " ${GRID}/Makefile | sed "s/^[^=]*=//") -I${GRID} -I${GRID}/Grid -I${NUMPY_INCLUDE} $(python3-config --includes)"
LDFLAGS="$(grep "GRID_LDFLAGS " ${GRID}/Makefile | sed "s/^[^=]*=//") $(grep "AM_LDFLAGS " ${GRID}/Makefile | sed "s/^[^=]*=//")"
LIBS=$(grep "GRID_LIBS " ${GRID}/Makefile | sed "s/^[^=]*=//")

echo "CXX = $CXX"
echo "CXXFLAGS = $CXXFLAGS"
echo "LDFLAGS = $LDFLAGS"
echo "LIBS = $LIBS"

echo "================================================================================"

./update

# Compile
for src in lib/*.cc lib/instantiate/*.cc
do
    bn=$(basename $src .cc)
    dst=build/${bn}.o
    if [ $src -nt $dst ];
    then
	(
	    echo " [CXX] $bn"
	    start=$SECONDS
	    ${CXX} --shared ${CXXFLAGS} -c $src -o $dst 1> logs/${bn}.out 2> logs/${bn}.err
	    success=$?
	    elapsed=$((SECONDS-start))
	    if [[ "$success" == "0" ]];
	    then
		printf "%-50s %s\n" " [OK ] $bn " "($elapsed s)"
	    else
		printf "%-50s %-30s %s\n" " [ERR] $bn " "($elapsed s)" "logs/${bn}.err"
	    fi
	) &
	N=$((N+1))
	if ((N==NPARALLEL))
	then
	    wait
	    N=0
	fi
    fi
done

wait

# Link
OBS="build/gversions.o build/basis.o  build/coordinates.o  build/eval.o  build/fp16.o  build/init.o build/mpi.o    build/operators.o  build/time.o  build/util.o
build/block.o  build/distribute.o build/grid.o  build/io.o    build/lib.o      build/munge.o  build/random.o     build/transform.o"
nvcc --link --shared build/lattice.o build/instantiate_*.o ${OBS} ${CXXFLAGS} ${LDFLAGS} ${LIBS} -lGrid -o ../cgpt.so

#nvcc --link --shared build/*.o ${CXXFLAGS} ${LDFLAGS} ${LIBS} -lGrid -o ../cgpt.so
