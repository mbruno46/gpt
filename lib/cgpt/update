#!/bin/bash

# Automatically generate list of exported functions
(
    echo "// This file is automatically generated, do not modify!" 
    sed -n 's/EXPORT(\([^,{]*\),{/EXPORT_FUNCTION(\1)/p' lib/*.cc 
) > lib/exports.h
echo "Found $(grep -c EXPORT lib/exports.h) exported functions"

# if exports changed, re-compile lib.o
if [ -f lib/exports.h~ ];
then
    diff lib/exports.h lib/exports.h~ > /dev/null
    if [[ "$?" != "0" ]];
    then
	rm -f build/lib.o
    fi
fi
cp lib/exports.h lib/exports.h~

# Automatically generate interface for exported fermion operators
(
    echo "// This file is automatically generated, do not modify!" 
    sed '1,/BEGIN_EXPORT_UNARY_REALD/d;/END_EXPORT_UNARY_REALD/,$d' lib/operators/types.h |
    awk '{ print "UNOP_REALD(" $1 "," NR + 1000 ")" }' 
    sed '1,/BEGIN_EXPORT_UNARY_VOID/d;/END_EXPORT_UNARY_VOID/,$d' lib/operators/types.h |
    awk '{ print "UNOP_VOID(" $1 "," NR + 2000 ")" }' 
) > lib/operators/register.h

(
    echo "# warning, this file is automatically generated, do not modify!"
    echo "def register(reg,op):"
    sed '1,/BEGIN_EXPORT_UNARY_REALD/d;/END_EXPORT_UNARY_REALD/,$d' lib/operators/types.h |
    awk '{ print "  reg." $1 " = lambda dst, src: op.unary(" NR + 1000 ",dst,src)" }' 
    sed '1,/BEGIN_EXPORT_UNARY_VOID/d;/END_EXPORT_UNARY_VOID/,$d' lib/operators/types.h |
    awk '{ print "  reg." $1 " = lambda dst, src: op.unary(" NR + 2000 ",dst,src)" }' 
) > ../gpt/qcd/fermion/register.py

# Automatically generate template instantiations
echo "// This file is automatically generated, do not modify!" > lib/instantiate/instantiate.h
git add lib/instantiate/instantiate.h

for precision in "vComplexF,single" "vComplexD,double"
do

    precision_vector=$(echo $precision | awk 'BEGIN{ FS="," }{ print $1 }')
    precision_tag=$(echo $precision | awk 'BEGIN{ FS="," }{ print $2 }')

    for tensor_group in 0 1 2
    do

	echo "INSTANTIATE(${precision_vector},${precision_tag},${tensor_group})" >> lib/instantiate/instantiate.h

	for f in lib/instantiate/templates/*.template
	do

	    g=lib/instantiate/$(basename $f .template)_${precision_tag}_${tensor_group}.cc

	    if [ $f -nt $g ];
	    then
		(
		    echo "// This file is automatically generated, do not modify!"
		    cat $f |
		    sed "s/{precision_vector}/${precision_vector}/g" |
		    sed "s/{precision_tag}/${precision_tag}/g" |
		    sed "s/{tensor_group}/${tensor_group}/g" 
		) > $g

		git add $g
	    fi

	done

    done

done
